{% extends 'base.html' %}
{% load static %}

{% block title %}Executive Dashboard - KPA Performance Monitoring{% endblock %}

{% block content %}
<div class="container-fluid">
  <!-- Executive Header -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h1 class="h2 mb-1 text-primary">
            <i class="bi bi-speedometer2 me-2"></i>Executive Dashboard
          </h1>
          <p class="text-muted mb-0">
            <i class="bi bi-calendar3 me-1"></i>
            {% if selected_year_id %}
              {% for fy in years %}
                {% if fy.id == selected_year_id %}{{ fy.year_code }}{% endif %}
              {% endfor %}
            {% endif %}
            <span class="mx-2">•</span>
            <i class="bi bi-clock me-1"></i>Last updated: {{ "now"|date:"M d, Y \a\t g:i A" }}
          </p>
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-secondary" onclick="window.print()">
            <i class="bi bi-printer me-1"></i>Print Report
          </button>
          <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#filtersModal">
            <i class="bi bi-funnel me-1"></i>Filters
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Key Performance Metrics -->
  <div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-3">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="flex-shrink-0">
              <div class="bg-success bg-gradient rounded-circle p-3">
                <i class="bi bi-check-circle-fill text-white fs-4"></i>
              </div>
            </div>
            <div class="flex-grow-1 ms-3">
              <div class="text-muted small">On Track</div>
              <div class="fs-2 fw-bold text-success">{{ summary.on_track|default:0 }}</div>
              <div class="text-success small">
                <i class="bi bi-arrow-up"></i>
                {% widthratio summary.on_track summary.total_kpas 100 %}% of total
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-3">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="flex-shrink-0">
              <div class="bg-warning bg-gradient rounded-circle p-3">
                <i class="bi bi-exclamation-triangle-fill text-white fs-4"></i>
              </div>
            </div>
            <div class="flex-grow-1 ms-3">
              <div class="text-muted small">At Risk</div>
              <div class="fs-2 fw-bold text-warning">{{ summary.at_risk|default:0 }}</div>
              <div class="text-warning small">
                <i class="bi bi-dash-circle"></i>
                Requires attention
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-3">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="flex-shrink-0">
              <div class="bg-danger bg-gradient rounded-circle p-3">
                <i class="bi bi-x-circle-fill text-white fs-4"></i>
              </div>
            </div>
            <div class="flex-grow-1 ms-3">
              <div class="text-muted small">Off Track</div>
              <div class="fs-2 fw-bold text-danger">{{ summary.off_track|default:0 }}</div>
              <div class="text-danger small">
                <i class="bi bi-arrow-down"></i>
                Critical intervention needed
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-3">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="flex-shrink-0">
              <div class="bg-primary bg-gradient rounded-circle p-3">
                <i class="bi bi-wallet2 text-white fs-4"></i>
              </div>
            </div>
            <div class="flex-grow-1 ms-3">
              <div class="text-muted small">Budget Utilization</div>
              <div class="fs-2 fw-bold text-primary">{{ summary.budget_burn|default:"N/A" }}</div>
              <div class="text-primary small">
                <i class="bi bi-graph-up"></i>
                Year to date spending
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Performance Overview Chart -->
  <div class="row mb-4">
    <div class="col-lg-8">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-white border-bottom">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
              <i class="bi bi-bar-chart me-2"></i>Performance Overview
            </h5>
            <div class="btn-group btn-group-sm" role="group">
              <input type="radio" class="btn-check" name="chartType" id="chartBar" checked>
              <label class="btn btn-outline-secondary" for="chartBar">
                <i class="bi bi-bar-chart"></i>
              </label>
              <input type="radio" class="btn-check" name="chartType" id="chartPie">
              <label class="btn btn-outline-secondary" for="chartPie">
                <i class="bi bi-pie-chart"></i>
              </label>
            </div>
          </div>
        </div>
        <div class="card-body">
          <canvas id="performanceChart" height="300"></canvas>
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-white border-bottom">
          <h5 class="mb-0">
            <i class="bi bi-speedometer2 me-2"></i>Performance Summary
          </h5>
        </div>
        <div class="card-body">
          <div class="text-center mb-4">
            <div class="position-relative d-inline-block">
              <canvas id="overallScoreChart" width="120" height="120"></canvas>
              <div class="position-absolute top-50 start-50 translate-middle text-center">
                <div class="fs-4 fw-bold text-primary">{{ summary.overall_score|default:"N/A" }}{% if summary.overall_score %}%{% endif %}</div>
                <div class="small text-muted">Overall</div>
              </div>
            </div>
          </div>

          <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center mb-1">
              <span class="small">Target Achievement</span>
              <span class="small fw-bold">{{ summary.target_achievement|default:"N/A" }}{% if summary.target_achievement %}%{% endif %}</span>
            </div>
            <div class="progress" style="height: 6px;">
              <div class="progress-bar bg-success" style="width: {{ summary.target_achievement|default:"0" }}%"></div>
            </div>
          </div>

          <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center mb-1">
              <span class="small">Budget Efficiency</span>
              <span class="small fw-bold">{{ summary.budget_efficiency|default:"92" }}%</span>
            </div>
            <div class="progress" style="height: 6px;">
              <div class="progress-bar bg-info" style="width: {{ summary.budget_efficiency|default:"92" }}%"></div>
            </div>
          </div>

          <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center mb-1">
              <span class="small">Timeline Adherence</span>
              <span class="small fw-bold">{{ summary.timeline_adherence|default:"N/A" }}{% if summary.timeline_adherence %}%{% endif %}</span>
            </div>
            <div class="progress" style="height: 6px;">
              <div class="progress-bar bg-warning" style="width: {{ summary.timeline_adherence|default:"0" }}%"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Strategic KPAs Overview -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-white border-bottom">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
              <i class="bi bi-bullseye me-2"></i>Strategic KPAs Performance
            </h5>
            <div class="d-flex gap-2">
              <div class="btn-group btn-group-sm" role="group">
                <input type="radio" class="btn-check" name="kpaView" id="kpaGrid" checked>
                <label class="btn btn-outline-secondary" for="kpaGrid">
                  <i class="bi bi-grid-3x3-gap"></i> Grid
                </label>
                <input type="radio" class="btn-check" name="kpaView" id="kpaList">
                <label class="btn btn-outline-secondary" for="kpaList">
                  <i class="bi bi-list"></i> List
                </label>
              </div>
              <a href="{% url 'kpa_list' %}" class="btn btn-sm btn-primary">
                <i class="bi bi-gear me-1"></i>Manage KPAs
              </a>
            </div>
          </div>
        </div>
        <div class="card-body">
          <div id="kpaGridView" class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-3">
            {% for k in kpa_cards %}
              <div class="col">
                <div class="card h-100 border-0 shadow-sm position-relative">
                  <!-- RAG Status Indicator -->
                  <div class="position-absolute top-0 end-0 m-2">
                    <span class="badge rounded-pill" style="background-color: {{ k.color }};">
                      {{ k.rag }}
                    </span>
                  </div>

                  <div class="card-body">
                    <h6 class="card-title mb-2">{{ k.title|truncatechars:50 }}</h6>
                    <div class="small text-muted mb-3">
                      <i class="bi bi-person me-1"></i>{{ k.owner|default:"Unassigned" }}
                    </div>

                    <!-- Progress Bar -->
                    <div class="mb-3">
                      <div class="d-flex justify-content-between align-items-center mb-1">
                        <span class="small text-muted">Progress</span>
                        <span class="small fw-bold">{{ k.percent|default:0 }}%</span>
                      </div>
                      <div class="progress" style="height: 8px;">
                        <div class="progress-bar"
                             style="width: {{ k.percent|default:0 }}%; background-color: {{ k.color }};"
                             role="progressbar"></div>
                      </div>
                    </div>

                    <!-- YTD Performance -->
                    <div class="row text-center">
                      <div class="col-6">
                        <div class="small text-muted">YTD Actual</div>
                        <div class="fw-bold">{{ k.ytd_actual|default:"—" }}</div>
                      </div>
                      <div class="col-6">
                        <div class="small text-muted">YTD Target</div>
                        <div class="fw-bold">{{ k.ytd_target|default:"—" }}</div>
                      </div>
                    </div>
                  </div>

                  <div class="card-footer bg-white border-0 pt-0">
                    <div class="d-grid">
                      <a href="{% url 'kpa_drilldown' k.id %}" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-eye me-1"></i>View Details
                      </a>
                    </div>
                  </div>
                </div>
              </div>
            {% empty %}
              <div class="col-12">
                <div class="text-center py-5">
                  <i class="bi bi-bullseye display-1 text-muted"></i>
                  <h5 class="mt-3 text-muted">No KPAs Available</h5>
                  <p class="text-muted mb-4">
                    {% if selected_year_id %}
                      No KPAs have been defined for the selected financial year yet.<br>
                      <small>Data will appear here once KPAs are created and progress is tracked.</small>
                    {% else %}
                      Please select a financial year to view KPAs.
                    {% endif %}
                  </p>
                  {% if perms.core.add_kpa %}
                    <a href="{% url 'kpa_list' %}" class="btn btn-primary">
                      <i class="bi bi-plus-circle me-1"></i>Create First KPA
                    </a>
                  {% endif %}
                </div>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters Modal -->
  <div class="modal fade" id="filtersModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="bi bi-funnel me-2"></i>Dashboard Filters
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <form method="get">
          <div class="modal-body">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Financial Year</label>
                <select name="year" class="form-select">
                  {% for fy in years %}
                    <option value="{{ fy.id }}" {% if fy.id == selected_year_id %}selected{% endif %}>
                      {{ fy.year_code }}
                    </option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Organizational Unit</label>
                <select name="unit" class="form-select">
                  <option value="">All Units</option>
                  {% for u in units %}
                    <option value="{{ u }}" {% if u == selected_unit %}selected{% endif %}>
                      {{ u|truncatechars:30 }}
                    </option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-12 mb-3">
                <label class="form-label">Reporting Period</label>
                <select name="period" class="form-select">
                  {% for p in periods %}
                    <option value="{{ p.value }}" {% if p.value == selected_period %}selected{% endif %}>
                      {{ p.label }}
                    </option>
                  {% endfor %}
                </select>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Apply Filters</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Performance Chart
  const performanceCtx = document.getElementById('performanceChart').getContext('2d');
  const performanceChart = new Chart(performanceCtx, {
    type: 'bar',
    data: {
      labels: ['On Track', 'At Risk', 'Off Track'],
      datasets: [{
        label: 'KPAs',
        data: [{{ summary.on_track|default:0 }}, {{ summary.at_risk|default:0 }}, {{ summary.off_track|default:0 }}],
        backgroundColor: [
          'rgba(25, 135, 84, 0.8)',
          'rgba(255, 193, 7, 0.8)',
          'rgba(220, 53, 69, 0.8)'
        ],
        borderColor: [
          'rgba(25, 135, 84, 1)',
          'rgba(255, 193, 7, 1)',
          'rgba(220, 53, 69, 1)'
        ],
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            stepSize: 1
          }
        }
      }
    }
  });

  // Overall Score Chart (Doughnut)
  const overallCtx = document.getElementById('overallScoreChart').getContext('2d');
  const overallChart = new Chart(overallCtx, {
    type: 'doughnut',
    data: {
      datasets: [{
        data: [{{ summary.overall_score|default:0 }}, {{ summary.overall_remaining|default:100 }}],
        backgroundColor: [
          'rgba(13, 110, 253, 0.8)',
          'rgba(233, 236, 239, 0.3)'
        ],
        borderWidth: 0
      }]
    },
    options: {
      responsive: false,
      cutout: '70%',
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          enabled: false
        }
      }
    }
  });

  // Chart type toggle
  document.querySelectorAll('input[name="chartType"]').forEach(radio => {
    radio.addEventListener('change', function() {
      if (this.id === 'chartPie') {
        performanceChart.config.type = 'pie';
      } else {
        performanceChart.config.type = 'bar';
      }
      performanceChart.update();
    });
  });

  // KPA view toggle
  document.querySelectorAll('input[name="kpaView"]').forEach(radio => {
    radio.addEventListener('change', function() {
      const gridView = document.getElementById('kpaGridView');
      if (this.id === 'kpaList') {
        gridView.className = 'row row-cols-1 g-2';
      } else {
        gridView.className = 'row row-cols-1 row-cols-md-2 row-cols-xl-3 g-3';
      }
    });
  });
});
</script>

<style>
@media print {
  .btn, .modal, .dropdown { display: none !important; }
  .card { break-inside: avoid; }
}

.progress {
  background-color: rgba(0,0,0,0.1);
}

.card:hover {
  transform: translateY(-2px);
  transition: transform 0.2s ease;
}

.badge {
  font-size: 0.75rem;
  padding: 0.35em 0.65em;
}
</style>
{% endblock %}

