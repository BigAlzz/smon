{% extends 'base.html' %}
{% load static %}

{% block title %}KPA Management{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h1 class="h4 mb-0">KPA Management</h1>
    <small class="text-muted">Manage Key Performance Areas for all organizational units</small>
  </div>
  <a class="btn btn-primary" href="{% url 'kpa_create' %}"><i class="bi bi-plus"></i> New KPA</a>
</div>

<!-- Statistics -->
<div class="row mb-3">
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body">
        <h5 class="card-title text-primary">{{ stats.total_kpas }}</h5>
        <p class="card-text small text-muted">Total KPAs</p>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body">
        <h5 class="card-title text-success">{{ stats.active_kpas }}</h5>
        <p class="card-text small text-muted">Active KPAs</p>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body">
        <h5 class="card-title text-info">{{ stats.current_year_kpas }}</h5>
        <p class="card-text small text-muted">Current Year</p>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body">
        <h5 class="card-title text-secondary">{{ page_obj.paginator.count }}</h5>
        <p class="card-text small text-muted">Filtered Results</p>
      </div>
    </div>
  </div>
</div>

<!-- Filters -->
<div class="card mb-3">
  <div class="card-body">
    <form method="get" class="row g-3">
      <div class="col-md-4">
        <label class="form-label" for="year">Financial Year</label>
        <select name="year" id="year" class="form-select">
          <option value="">All Years</option>
          {% for year in years %}
            <option value="{{ year.id }}" {% if year.id|stringformat:"s" == selected_year_id %}selected{% endif %}>
              {{ year.year_code }}
            </option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-6">
        <label class="form-label" for="search">Search</label>
        <input type="text" name="search" id="search" class="form-control" 
               value="{{ search_query }}" placeholder="Search by title, description, or strategic objective...">
      </div>
      <div class="col-md-2 d-flex align-items-end">
        <button type="submit" class="btn btn-outline-primary me-2">Filter</button>
        <a href="{% url 'kpa_list' %}" class="btn btn-outline-secondary">Clear</a>
      </div>
    </form>
  </div>
</div>

<!-- KPA List -->
<div class="card">
  <div class="card-body">
    {% if page_obj.object_list %}
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead>
            <tr>
              <th>
                <a href="?{% if request.GET.sort == 'title' and request.GET.order != 'desc' %}sort=title&order=desc{% else %}sort=title&order=asc{% endif %}{% for key, value in request.GET.items %}{% if key != 'sort' and key != 'order' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="text-decoration-none text-dark d-flex align-items-center">
                  Title
                  {% if request.GET.sort == 'title' %}
                    <i class="bi bi-chevron-{% if request.GET.order == 'desc' %}down{% else %}up{% endif %} ms-1"></i>
                  {% endif %}
                </a>
              </th>
              <th>
                <a href="?{% if request.GET.sort == 'financial_year' and request.GET.order != 'desc' %}sort=financial_year&order=desc{% else %}sort=financial_year&order=asc{% endif %}{% for key, value in request.GET.items %}{% if key != 'sort' and key != 'order' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="text-decoration-none text-dark d-flex align-items-center">
                  Financial Year
                  {% if request.GET.sort == 'financial_year' %}
                    <i class="bi bi-chevron-{% if request.GET.order == 'desc' %}down{% else %}up{% endif %} ms-1"></i>
                  {% endif %}
                </a>
              </th>
              <th>
                <a href="?{% if request.GET.sort == 'owner' and request.GET.order != 'desc' %}sort=owner&order=desc{% else %}sort=owner&order=asc{% endif %}{% for key, value in request.GET.items %}{% if key != 'sort' and key != 'order' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="text-decoration-none text-dark d-flex align-items-center">
                  Owner
                  {% if request.GET.sort == 'owner' %}
                    <i class="bi bi-chevron-{% if request.GET.order == 'desc' %}down{% else %}up{% endif %} ms-1"></i>
                  {% endif %}
                </a>
              </th>
              <th>Organizational Units</th>
              <th>
                <a href="?{% if request.GET.sort == 'order' and request.GET.order != 'desc' %}sort=order&order=desc{% else %}sort=order&order=asc{% endif %}{% for key, value in request.GET.items %}{% if key != 'sort' and key != 'order' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="text-decoration-none text-dark d-flex align-items-center">
                  Order
                  {% if request.GET.sort == 'order' %}
                    <i class="bi bi-chevron-{% if request.GET.order == 'desc' %}down{% else %}up{% endif %} ms-1"></i>
                  {% endif %}
                </a>
              </th>
              <th>
                <a href="?{% if request.GET.sort == 'is_active' and request.GET.order != 'desc' %}sort=is_active&order=desc{% else %}sort=is_active&order=asc{% endif %}{% for key, value in request.GET.items %}{% if key != 'sort' and key != 'order' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="text-decoration-none text-dark d-flex align-items-center">
                  Status
                  {% if request.GET.sort == 'is_active' %}
                    <i class="bi bi-chevron-{% if request.GET.order == 'desc' %}down{% else %}up{% endif %} ms-1"></i>
                  {% endif %}
                </a>
              </th>
              <th class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for kpa in page_obj %}
              <tr>
                <td>
                  <div class="fw-semibold">{{ kpa.title }}</div>
                  <div class="small text-muted">{{ kpa.description|truncatechars:80 }}</div>
                </td>
                <td>
                  <span class="badge bg-secondary">{{ kpa.financial_year.year_code }}</span>
                </td>
                <td>{{ kpa.owner.get_full_name|default:kpa.owner.username }}</td>
                <td>
                  <div class="small">
                    {% for unit in kpa.org_units.all %}
                      <span class="badge bg-light text-dark me-1">{{ unit.name }}</span>
                    {% empty %}
                      <span class="text-muted">â€”</span>
                    {% endfor %}
                  </div>
                </td>
                <td>{{ kpa.order }}</td>
                <td>
                  {% if kpa.is_active %}
                    <span class="badge bg-success">Active</span>
                  {% else %}
                    <span class="badge bg-secondary">Inactive</span>
                  {% endif %}
                </td>
                <td class="text-end">
                  <div class="btn-group btn-group-sm">
                    <a href="{% url 'kpa_drilldown' kpa.id %}" class="btn btn-outline-primary" title="View Details">
                      <i class="bi bi-eye"></i>
                    </a>
                    <a href="{% url 'kpa_edit' kpa.id %}" class="btn btn-outline-secondary" title="Edit">
                      <i class="bi bi-pencil"></i>
                    </a>
                    <a href="{% url 'kpa_delete' kpa.id %}" class="btn btn-outline-danger" title="Delete">
                      <i class="bi bi-trash"></i>
                    </a>
                  </div>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      {% if page_obj.has_other_pages %}
        <nav aria-label="KPA pagination" class="mt-3">
          <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
              <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}&year={{ selected_year_id }}&search={{ search_query }}&sort={{ request.GET.sort }}&order={{ request.GET.order }}">
                  Previous
                </a>
              </li>
            {% else %}
              <li class="page-item disabled">
                <span class="page-link">Previous</span>
              </li>
            {% endif %}

            {% for num in page_obj.paginator.page_range %}
              {% if page_obj.number == num %}
                <li class="page-item active">
                  <span class="page-link">{{ num }}</span>
                </li>
              {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                <li class="page-item">
                  <a class="page-link" href="?page={{ num }}&year={{ selected_year_id }}&search={{ search_query }}&sort={{ request.GET.sort }}&order={{ request.GET.order }}">{{ num }}</a>
                </li>
              {% endif %}
            {% endfor %}

            {% if page_obj.has_next %}
              <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}&year={{ selected_year_id }}&search={{ search_query }}&sort={{ request.GET.sort }}&order={{ request.GET.order }}">
                  Next
                </a>
              </li>
            {% else %}
              <li class="page-item disabled">
                <span class="page-link">Next</span>
              </li>
            {% endif %}
          </ul>
        </nav>
      {% endif %}

    {% else %}
      <div class="text-center py-5">
        <i class="bi bi-folder2-open display-1 text-muted"></i>
        <h5 class="mt-3">No KPAs Found</h5>
        <p class="text-muted">
          {% if search_query or selected_year_id %}
            No KPAs match your current filters. Try adjusting your search criteria.
          {% else %}
            No KPAs have been created yet.
          {% endif %}
        </p>
        <a href="{% url 'kpa_create' %}" class="btn btn-primary">Create First KPA</a>
      </div>
    {% endif %}
  </div>
</div>

<div class="mt-3">
  <small class="text-muted">
    Showing {{ page_obj.start_index }}-{{ page_obj.end_index }} of {{ page_obj.paginator.count }} KPAs
  </small>
</div>
{% endblock %}
