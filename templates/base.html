{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="csrf-token" content="{{ csrf_token }}" />
  <title>{% block title %}KPA Monitoring{% endblock %}</title>

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
  <link rel="stylesheet" href="{% static 'css/app.css' %}">

  <style>
    body {
      padding-top: 3.2rem;
      transition: background-color 0.3s ease, color 0.3s ease;
    }



    [data-bs-theme="dark"] .navbar,
    .dark-theme .navbar {
      --bs-navbar-bg: #212529 !important;
      --bs-navbar-border-color: #495057 !important;
      background-color: #212529 !important;
      border-color: #495057 !important;
    }

    [data-bs-theme="dark"] .card,
    .dark-theme .card {
      --bs-card-bg: #2d3748 !important;
      --bs-card-border-color: #4a5568 !important;
      background-color: #2d3748 !important;
      border-color: #4a5568 !important;
      color: #e9ecef !important;
    }

    [data-bs-theme="dark"] .table,
    .dark-theme .table {
      --bs-table-bg: #2d3748 !important;
      --bs-table-striped-bg: #374151 !important;
      --bs-table-hover-bg: #4a5568 !important;
      background-color: #2d3748 !important;
      color: #e9ecef !important;
    }

    [data-bs-theme="dark"] .btn-outline-secondary,
    .dark-theme .btn-outline-secondary {
      --bs-btn-color: #adb5bd !important;
      --bs-btn-border-color: #6c757d !important;
      --bs-btn-hover-color: #fff !important;
      --bs-btn-hover-bg: #6c757d !important;
      color: #adb5bd !important;
      border-color: #6c757d !important;
    }

    [data-bs-theme="dark"] .form-control,
    [data-bs-theme="dark"] .form-select,
    .dark-theme .form-control,
    .dark-theme .form-select {
      background-color: #374151 !important;
      border-color: #4a5568 !important;
      color: #e9ecef !important;
    }

    [data-bs-theme="dark"] .form-control:focus,
    [data-bs-theme="dark"] .form-select:focus,
    .dark-theme .form-control:focus,
    .dark-theme .form-select:focus {
      background-color: #374151 !important;
      border-color: #0d6efd !important;
      color: #e9ecef !important;
      box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25) !important;
    }

    /* Additional dark mode styles */
    [data-bs-theme="dark"] .text-muted,
    .dark-theme .text-muted {
      color: #adb5bd !important;
    }

    [data-bs-theme="dark"] .bg-light,
    .dark-theme .bg-light {
      background-color: #2d3748 !important;
      color: #e9ecef !important;
    }

    [data-bs-theme="dark"] .border,
    .dark-theme .border {
      border-color: #4a5568 !important;
    }

    [data-bs-theme="dark"] .dropdown-menu,
    .dark-theme .dropdown-menu {
      background-color: #2d3748 !important;
      border-color: #4a5568 !important;
    }

    [data-bs-theme="dark"] .dropdown-item,
    .dark-theme .dropdown-item {
      color: #e9ecef !important;
    }

    [data-bs-theme="dark"] .dropdown-item:hover,
    .dark-theme .dropdown-item:hover {
      background-color: #374151 !important;
      color: #e9ecef !important;
    }

    [data-bs-theme="dark"] .alert,
    .dark-theme .alert {
      border-color: #4a5568 !important;
    }

    [data-bs-theme="dark"] .badge,
    .dark-theme .badge {
      color: #fff !important;
    }



    .navbar-light .theme-toggle:hover {
      color: #fff !important;
      background-color: #6c757d !important;
      border-color: #6c757d !important;
    }

    .navbar-dark .theme-toggle {
      color: #adb5bd !important;
      border-color: #6c757d !important;
    }

    .navbar-dark .theme-toggle:hover {
      color: #fff !important;
      background-color: #6c757d !important;
      border-color: #6c757d !important;
    }

    /* User dropdown improvements */
    .user-dropdown .dropdown-toggle::after {
      display: none;
    }

    .user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 0.875rem;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top navbar-sm">
    <div class="container-fluid">
      <a class="navbar-brand" href="{% url 'dashboard' %}">KPA Monitoring</a>
      <div class="collapse navbar-collapse">
        <ul class="navbar-nav ms-auto">
          {% if user.is_authenticated %}
            <li class="nav-item"><a class="nav-link" href="{% url 'dashboard' %}">Dashboard</a></li>
            <li class="nav-item"><a class="nav-link" href="{% url 'kpa_list' %}">KPAs</a></li>
            <li class="nav-item"><a class="nav-link" href="{% url 'plan_grid' %}">Operational Plan</a></li>
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                Organization
              </a>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="{% url 'org_chart' %}"><i class="bi bi-diagram-3"></i> Org Chart</a></li>
                <li><a class="dropdown-item" href="{% url 'staff_accounts' %}"><i class="bi bi-people"></i> Staff Directory</a></li>
              </ul>
            </li>
            {% if user.profile.primary_role in 'SENIOR_MANAGER,PROGRAMME_MANAGER' or user.owned_kpas.exists %}
              <li class="nav-item"><a class="nav-link" href="{% url 'manager_dashboard' %}">Manager Dashboard</a></li>
            {% endif %}

            <!-- Notifications Bell -->
            <li class="nav-item position-relative">
              <a class="nav-link position-relative" href="{% url 'notification_inbox' %}" id="notificationBell" title="Open Communications">
                <i class="bi bi-bell"></i>
                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="notificationBadge" style="display: none;">
                  0
                </span>
              </a>
              <div class="dropdown-menu dropdown-menu-end notification-dropdown position-absolute" style="width: 350px; top: 100%; right: 0; z-index: 1050;">
                <div class="dropdown-header d-flex justify-content-between align-items-center">
                  <span>Notifications</span>
                  <a href="{% url 'notification_inbox' %}" class="btn btn-sm btn-outline-primary">View All</a>
                </div>
                <div class="dropdown-divider"></div>
                <div id="notificationList" class="notification-list" style="max-height: 300px; overflow-y: auto;">
                  <div class="text-center py-3">
                    <div class="spinner-border spinner-border-sm" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>
                  </div>
                </div>
                <div class="dropdown-divider"></div>
                <div class="dropdown-footer text-center">
                  <a href="{% url 'compose_message' %}" class="btn btn-sm btn-primary">
                    <i class="bi bi-plus"></i> Compose Message
                  </a>
                </div>
              </div>
            </li>



            <!-- User Dropdown -->
            <li class="nav-item dropdown user-dropdown">
              <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                <div class="user-avatar me-2">
                  {% if user.first_name and user.last_name %}
                    {{ user.first_name|first|upper }}{{ user.last_name|first|upper }}
                  {% else %}
                    {{ user.username|first|upper }}
                  {% endif %}
                </div>
                <span class="d-none d-md-inline">
                  {% if user.get_full_name %}
                    {{ user.get_full_name }}
                  {% else %}
                    {{ user.username }}
                  {% endif %}
                </span>
                <i class="bi bi-chevron-down ms-1"></i>
              </a>
              <ul class="dropdown-menu dropdown-menu-end">
                <li>
                  <div class="dropdown-header">
                    <div class="fw-bold">
                      {% if user.get_full_name %}
                        {{ user.get_full_name }}
                      {% else %}
                        {{ user.username }}
                      {% endif %}
                    </div>
                    <small class="text-muted">{{ user.email }}</small>
                    {% if user.profile.job_title %}
                      <small class="text-muted d-block">{{ user.profile.job_title }}</small>
                    {% endif %}
                  </div>
                </li>
                <li><hr class="dropdown-divider"></li>
                <li>
                  <a class="dropdown-item" href="{% url 'profile' %}">
                    <i class="bi bi-person me-2"></i>My Profile
                  </a>
                </li>
                <li>
                  <a class="dropdown-item" href="{% url 'change_password' %}">
                    <i class="bi bi-key me-2"></i>Change Password
                  </a>
                </li>
                {% if user.profile.primary_role == 'SYSTEM_ADMIN' or user.is_superuser %}
                  <li><hr class="dropdown-divider"></li>
                  <li>
                    <a class="dropdown-item" href="{% url 'staff_accounts' %}">
                      <i class="bi bi-people me-2"></i>User Management
                    </a>
                  </li>
                {% endif %}
                <li><hr class="dropdown-divider"></li>
                <li>
                  <a class="dropdown-item text-danger" href="{% url 'logout' %}">
                    <i class="bi bi-box-arrow-right me-2"></i>Sign Out
                  </a>
                </li>
              </ul>
            </li>
          {% else %}
            <li class="nav-item"><a class="nav-link" href="{% url 'login' %}">Login</a></li>
          {% endif %}
        </ul>
      </div>
    </div>
  </nav>

  <main class="container">
    {% if messages %}
      <div class="mt-2">
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {% if message.tags == 'success' %}
              <i class="bi bi-check-circle-fill me-2"></i>
            {% elif message.tags == 'error' %}
              <i class="bi bi-exclamation-triangle-fill me-2"></i>
            {% elif message.tags == 'warning' %}
              <i class="bi bi-exclamation-circle-fill me-2"></i>
            {% elif message.tags == 'info' %}
              <i class="bi bi-info-circle-fill me-2"></i>
            {% endif %}
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      </div>
    {% endif %}

    {% block content %}{% endblock %}
  </main>
  <!-- New messages toast (top right) -->
  <div class="toast-container position-fixed top-0 end-0 p-3" id="newMessagesToastContainer" style="z-index: 2000;">
    <div id="newMessagesToast" class="toast align-items-center text-bg-primary border-0" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="5000" style="display:none;">
      <div class="d-flex">
        <div class="toast-body">
          <i class="bi bi-envelope-fill me-2"></i>
          New messages in Communications
        </div>
        <a href="{% url 'notification_inbox' %}" class="btn btn-sm btn-light me-2 my-auto">Open</a>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  </div>

  <!-- Toast container for additional notifications -->
  <div class="toast-container position-fixed bottom-0 end-0 p-3">
    {% if messages %}
      {% for message in messages %}
        {% if message.tags == 'success' %}
          <div class="toast show" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="6000">
            <div class="toast-header bg-success text-white">
              <i class="bi bi-check-circle-fill me-2"></i>
              <strong class="me-auto">Success!</strong>

              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
              {{ message|truncatewords:15 }}
            </div>
          </div>
        {% endif %}
      {% endfor %}
    {% endif %}
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

  <!-- CSRF Token Setup for JavaScript -->
  <script>
    // Global CSRF token function
    window.getCSRFToken = function() {
      // Try meta tag first
      const metaToken = document.querySelector('meta[name="csrf-token"]');
      if (metaToken) {
        return metaToken.getAttribute('content');
      }

      // Try cookie fallback
      const name = 'csrftoken=';
      const cookies = document.cookie.split(';');
      for (let cookie of cookies) {
        cookie = cookie.trim();
        if (cookie.startsWith(name)) {
          return cookie.substring(name.length);
        }
      }

      // Try form token fallback
      const formToken = document.querySelector('input[name="csrfmiddlewaretoken"]');
      if (formToken) {
        return formToken.value;
      }

      console.warn('CSRF token not found');
      return '';
    };

    // Debug function
    window.debugCSRF = function() {
      console.log('CSRF Debug Info:');
      console.log('Meta token:', document.querySelector('meta[name="csrf-token"]')?.getAttribute('content'));
      console.log('Cookie:', document.cookie.split(';').find(c => c.trim().startsWith('csrftoken=')));
      console.log('Form token:', document.querySelector('input[name="csrfmiddlewaretoken"]')?.value);
      console.log('Current token:', window.getCSRFToken());
    };
  </script>

  <script src="{% static 'js/app.js' %}"></script>
  <script src="{% static 'js/currency.js' %}"></script>
  <script src="{% static 'js/kpa-preview.js' %}"></script>
  <script src="{% static 'js/kpa-form.js' %}"></script>
  <script src="{% static 'js/orgunits-cascade.js' %}"></script>

  <!-- Success feedback enhancements -->
  <style>
    .alert-success {
      border-left: 4px solid #28a745;
      background-color: #d4edda;
      border-color: #c3e6cb;
      animation: slideInDown 0.5s ease-out;
    }

    .alert-success .bi-check-circle-fill {
      color: #28a745;
      font-size: 1.2em;
    }

    @keyframes slideInDown {
      from {
        transform: translateY(-20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .alert-success.show {
      animation: slideInDown 0.5s ease-out;
    }

    /* Pulse animation for extra emphasis */
    .alert-success:hover {
      animation: pulse 0.5s ease-in-out;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.02); }
      100% { transform: scale(1); }
    }

    @keyframes successPulse {
      0% {
        transform: scale(1);
        box-shadow: 0 0 20px rgba(40, 167, 69, 0.3);
      }
      50% {
        transform: scale(1.02);
        box-shadow: 0 0 30px rgba(40, 167, 69, 0.5);
      }
      100% {
        transform: scale(1);
        box-shadow: 0 0 20px rgba(40, 167, 69, 0.3);
      }
    }

    /* Notification dropdown animations */
    .notification-dropdown {
      transition: opacity 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94),
                  visibility 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94),
                  transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      opacity: 0;
      visibility: hidden;
      transform: translateY(-15px) scale(0.95);
      box-shadow: 0 10px 25px rgba(0,0,0,0.15);
      border: 1px solid rgba(0,0,0,0.1);
      border-radius: 8px;
    }

    .notification-dropdown.show {
      opacity: 1;
      visibility: visible;
      transform: translateY(0) scale(1);
    }

    /* Fade out animation */
    .notification-dropdown.hiding {
      opacity: 0;
      transform: translateY(-10px) scale(0.98);
      transition: opacity 0.3s ease, transform 0.3s ease;
    }

    /* Notification bell hover effect */
    #notificationBell {
      transition: color 0.2s ease, transform 0.2s ease;
    }

    #notificationBell:hover {
      color: #0d6efd !important;
      transform: scale(1.1);
    }

    /* Bell shake animation for new notifications */
    @keyframes bell-shake {
      0%, 100% { transform: rotate(0deg); }
      10%, 30%, 50%, 70%, 90% { transform: rotate(-10deg); }
      20%, 40%, 60%, 80% { transform: rotate(10deg); }
    }

    /* Notification badge pulse animation */
    #notificationBadge {
      animation: pulse-badge 2s infinite;
    }

    @keyframes pulse-badge {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    /* Notification list item hover */
    .notification-dropdown .dropdown-item {
      transition: background-color 0.2s ease;
      border-left: 3px solid transparent;
    }

    .notification-dropdown .dropdown-item:hover {
      background-color: #f8f9fa;
      border-left-color: #0d6efd;
    }

    /* Unread notification styling */
    .notification-dropdown .dropdown-item.fw-bold {
      background-color: #e3f2fd;
      border-left-color: #2196f3;
    }
  </style>

  <!-- Enhanced success message handling -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Enhanced success message handling
      const successAlerts = document.querySelectorAll('.alert-success');
      successAlerts.forEach(function(alert) {
        // Add extra emphasis for progress submissions
        if (alert.textContent.includes('SUBMITTED') || alert.textContent.includes('SUCCESS!')) {
          alert.style.cssText += `
            border: 3px solid #28a745;
            box-shadow: 0 0 20px rgba(40, 167, 69, 0.3);
            animation: successPulse 2s ease-in-out;
          `;

          // Add celebration sound
          playSuccessSound();
        }

        // Auto-dismiss after 12 seconds (longer for important messages)
        const dismissTime = alert.textContent.includes('SUCCESS!') ? 12000 : 8000;
        setTimeout(function() {
          const bsAlert = new bootstrap.Alert(alert);
          bsAlert.close();
        }, dismissTime);
      });

      // Enhanced success sound function
      function playSuccessSound() {
        try {
          const audioContext = new (window.AudioContext || window.webkitAudioContext)();

          // Create a more pleasant success sound sequence
          const frequencies = [523.25, 659.25, 783.99]; // C5, E5, G5 chord

          frequencies.forEach((freq, index) => {
            setTimeout(() => {
              const oscillator = audioContext.createOscillator();
              const gainNode = audioContext.createGain();

          oscillator.connect(gainNode);
          gainNode.connect(audioContext.destination);

          oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
          oscillator.frequency.setValueAtTime(1000, audioContext.currentTime + 0.1);

          gainNode.gain.setValueAtTime(0, audioContext.currentTime);
          gainNode.gain.linearRampToValueAtTime(0.1, audioContext.currentTime + 0.01);
          gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);

          oscillator.start(audioContext.currentTime);
          oscillator.stop(audioContext.currentTime + 0.2);
        } catch (e) {
          // Ignore audio errors - not critical
        }
      }

      // Initialize notifications system
      {% if user.is_authenticated %}
        initializeNotifications();
      {% endif %}
    });

    {% if user.is_authenticated %}
    // Notification system functions
    function initializeNotifications() {
      loadNotificationCount();
      loadRecentNotifications();

      // Refresh notifications every 30 seconds
      setInterval(function() {
        loadNotificationCount();
        loadRecentNotifications();
      }, 30000);

      // Load notifications when dropdown is opened
      const notificationBell = document.getElementById('notificationBell');
      const notificationDropdown = notificationBell.nextElementSibling;
      let hideTimeout;

      // Show dropdown on click
      // Show inline dropdown on hover only
      notificationBell.addEventListener('mouseenter', function() {
        loadRecentNotifications();
        showNotificationDropdown();
      });
      notificationBell.addEventListener('mouseleave', function() {
        // will hide after delay unless hovering the dropdown
      });

      // Auto-hide functionality
      function showNotificationDropdown() {
        notificationDropdown.classList.add('show');
        clearTimeout(hideTimeout);

        // Hide after 5 seconds if not hovered
        hideTimeout = setTimeout(() => {
          if (!notificationDropdown.matches(':hover') && !notificationBell.matches(':hover')) {
            hideNotificationDropdown();
          }
        }, 5000);
      }

      function hideNotificationDropdown() {
        // Add hiding class for fade-out animation
        notificationDropdown.classList.add('hiding');

        // Remove show class after animation starts
        setTimeout(() => {
          notificationDropdown.classList.remove('show', 'hiding');
        }, 300);

        clearTimeout(hideTimeout);
      }

      // Keep dropdown open when hovering
      notificationDropdown.addEventListener('mouseenter', function() {
        clearTimeout(hideTimeout);
      });

      // Start hide timer when mouse leaves
      notificationDropdown.addEventListener('mouseleave', function() {
        hideTimeout = setTimeout(() => {
          hideNotificationDropdown();
        }, 1000); // 1 second delay after mouse leaves
      });

      // Also handle bell hover
      notificationBell.addEventListener('mouseenter', function() {
        clearTimeout(hideTimeout);
      });

      notificationBell.addEventListener('mouseleave', function() {
        if (notificationDropdown.classList.contains('show')) {
          hideTimeout = setTimeout(() => {
            if (!notificationDropdown.matches(':hover')) {
              hideNotificationDropdown();
            }
          }, 1000);
        }
      });

      // Hide when clicking outside
      document.addEventListener('click', function(e) {
        if (!notificationBell.contains(e.target) && !notificationDropdown.contains(e.target)) {
          hideNotificationDropdown();
        }
      });
    }

    let previousUnreadCount = 0;

    function loadNotificationCount() {
      fetch('/notifications/api/unread-count/')
        .then(response => response.json())
        .then(data => {
          const badge = document.getElementById('notificationBadge');
          const currentCount = data.unread_count;

          // Check if we have new notifications
          if (currentCount > previousUnreadCount) {
            // New notifications arrived - play sound, animate and show toast
            playNotificationSound();
            animateNotificationBell();
            showNewMessagesToast(currentCount);
          }

          if (currentCount > 0) {
            badge.textContent = currentCount > 99 ? '99+' : currentCount;
            badge.style.display = 'block';
          } else {
            badge.style.display = 'none';
          }

          previousUnreadCount = currentCount;
        })
        .catch(error => console.error('Error loading notification count:', error));
    function showNewMessagesToast(count) {
      try {
        const toastEl = document.getElementById('newMessagesToast');
        if (!toastEl) return;
        const msg = toastEl.querySelector('.toast-body');
        if (msg) {
          msg.innerHTML = `<i class="bi bi-envelope-fill me-2"></i>${count} new message${count === 1 ? '' : 's'} in Communications`;
        }
        toastEl.style.display = 'block';
        const toast = new bootstrap.Toast(toastEl);
        toast.show();
      } catch (e) {
        console.warn('Toast not available', e);
      }
    }

    }

    function playNotificationSound() {
      try {
        // Create a subtle notification sound
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);

        // Pleasant notification tone
        oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
        oscillator.frequency.setValueAtTime(1000, audioContext.currentTime + 0.1);
        oscillator.frequency.setValueAtTime(1200, audioContext.currentTime + 0.2);

        gainNode.gain.setValueAtTime(0, audioContext.currentTime);
        gainNode.gain.linearRampToValueAtTime(0.05, audioContext.currentTime + 0.01);
        gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.3);

        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.3);
      } catch (e) {
        // Ignore audio errors - not critical
      }
    }

    function animateNotificationBell() {
      const bell = document.getElementById('notificationBell');
      bell.style.animation = 'none';
      setTimeout(() => {
        bell.style.animation = 'bell-shake 0.5s ease-in-out';
      }, 10);
    }

    function loadRecentNotifications() {
      const listContainer = document.getElementById('notificationList');

      // Show loading spinner
      listContainer.innerHTML = `
        <div class="text-center py-3">
          <div class="spinner-border spinner-border-sm" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
      `;

      fetch('/notifications/api/recent/')
        .then(response => response.json())
        .then(data => {
          if (data.notifications.length === 0) {
            listContainer.innerHTML = `
              <div class="text-center py-4 text-muted">
                <i class="bi bi-bell-slash display-6"></i>
                <div class="mt-2">No notifications</div>
                <small>You're all caught up!</small>
              </div>
            `;
          } else {
            const notificationsHtml = data.notifications.map(notification => {
              const priorityClass = notification.priority === 'URGENT' ? 'text-danger' :
                                  notification.priority === 'HIGH' ? 'text-warning' : '';
              const unreadClass = notification.is_read ? '' : 'fw-bold';

              // Format timestamp
              const sentDate = new Date(notification.sent_at);
              const timeAgo = getTimeAgo(sentDate);

              return `
                <a href="${notification.url}" class="dropdown-item ${unreadClass}" style="white-space: normal; padding: 12px 16px;">
                  <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                      <div class="d-flex align-items-center mb-1">
                        ${getPriorityIcon(notification.priority)}
                        <div class="small ${priorityClass} flex-grow-1">${notification.title}</div>
                        ${!notification.is_read ? '<span class="badge bg-primary ms-2">New</span>' : ''}
                      </div>
                      <div class="text-muted small mb-1">${notification.message}</div>
                      <div class="text-muted small d-flex justify-content-between">
                        <span>From: ${notification.sender}</span>
                        <span>${timeAgo}</span>
                      </div>
                    </div>
                  </div>
                </a>
              `;
            }).join('');

            listContainer.innerHTML = notificationsHtml;
          }
        })
        .catch(error => {
          console.error('Error loading notifications:', error);
          listContainer.innerHTML = `
            <div class="text-center py-4 text-danger">
              <i class="bi bi-exclamation-triangle display-6"></i>
              <div class="mt-2">Error loading notifications</div>
              <small>Please try again later</small>
            </div>
          `;
        });
    }

    function getPriorityIcon(priority) {
      switch(priority) {
        case 'URGENT':
          return '<i class="bi bi-exclamation-triangle-fill text-danger me-2"></i>';
        case 'HIGH':
          return '<i class="bi bi-exclamation-circle-fill text-warning me-2"></i>';
        default:
          return '<i class="bi bi-info-circle text-primary me-2"></i>';
      }
    }

    function getTimeAgo(date) {
      const now = new Date();
      const diffInSeconds = Math.floor((now - date) / 1000);

      if (diffInSeconds < 60) return 'Just now';
      if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
      if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;
      if (diffInSeconds < 604800) return `${Math.floor(diffInSeconds / 86400)}d ago`;

      return date.toLocaleDateString();
    }
    {% endif %}


  </script>
</body>
</html>

